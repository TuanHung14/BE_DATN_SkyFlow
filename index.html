<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Đặt ghế xem phim</title>
    <style>
        body { font-family: Arial; text-align: center; padding: 20px; }
        .seat {
            width: 30px;
            height: 30px;
            margin: 5px;
            background-color: #ddd;
            border-radius: 5px;
            display: inline-block;
            cursor: pointer;
        }
        .held { background-color: orange; }
        .selected { background-color: #034EA2; }
        .booking { background-color: #1A2C50; }
        .screen {
            margin: 20px auto;
            width: 300px;
            background: #444;
            color: white;
            padding: 10px;
        }
    </style>
</head>
<body>

<h1>Chọn ghế xem phim</h1>
<div class="screen">MÀN HÌNH</div>
<div id="seat-container"></div>
<button id="hold-btn">Tiếp tục</button>
<a id="confirm-btn" href="payment.html">Đặt ghế</a>
<button id="proceeded-btn">Hủy tất cả</button>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const showtimeId = "abc123";
    const userId = Math.random(); // cần pass từ backend ra
    const socket = io("http://localhost:3000");

    const seatContainer = document.getElementById('seat-container');
    const totalSeats = 40;
    const seats = {};

    // Tạo ghế
    for (let i = 1; i <= totalSeats; i++) {
        const seat = document.createElement('div');
        const seatId = `S${i}`;
        seat.classList.add('seat');
        seat.dataset.id = seatId;
        seat.innerText = i;
        seat.addEventListener('click', () => {
            if (seat.classList.contains('booking')) return;

            if (seat.classList.contains('selected')) {
                // Huỷ giữ
                socket.emit('release-seat', { showtimeId, seatId });
                seat.classList.remove('selected');
            } else {
                // Giữ ghế
                socket.emit('hold-seat', { showtimeId, seatId });
            }
        });
        seats[seatId] = seat;
        seatContainer.appendChild(seat);
    }

    // Kết nối và tham gia phòng
    socket.on('connect', () => {
        socket.emit('join-room', { showtimeId, userId });
    });

    // Nhận danh sách ghế khi vào phòng
    socket.on('seats-hold', ({ holds, bookings }) => {
        Object.keys(holds).forEach(seatId => {
            if (seats[seatId]) {
                seats[seatId].classList.add('held');
            }
        });
        Object.keys(bookings).forEach(seatId => {
            if (seats[seatId]) {
                seats[seatId].classList.add('booking');
            }
        });
    });

    socket.on('seats-hold-me', ({ holds }) => {
        holds.forEach(seatId => {
            if (seats[seatId]) {
                seats[seatId].classList.add('selected');
                seats[seatId].classList.remove('held');
            }
        });
    });

    // Người khác giữ ghế
    socket.on('seat-held', ({ seatId }) => {
        if (seats[seatId]) {
            seats[seatId].classList.add('held');
            seats[seatId].classList.remove('selected');
        }
    });

    // Mình giữ ghế
    socket.on('seats-held-me', ({ seatId }) => {
        if (seats[seatId]) {
            seats[seatId].classList.add('selected');
            seats[seatId].classList.remove('held');
        }
    });

    // Ghế được đặt thành công
    socket.on('seats-booked', (bookings) => {
        bookings.forEach(({ seatId }) => {
            if (seats[seatId]) {
                seats[seatId].classList.remove('selected');
                seats[seatId].classList.add('booking');
            }
        });
    });

    // Ghế được huỷ
    socket.on('seat-released', ({ seatId }) => {
        if (seats[seatId]) {
            seats[seatId].classList.remove('held', 'selected', 'booking');
        }
    });

    // Lỗi
    socket.on('error', ({ message }) => {
        alert(message);
    });

    // Nút tiếp tục: giữ sang trạng thái "process"
    document.getElementById('hold-btn').addEventListener('click', () => {
        socket.emit('confirm-hold', { showtimeId });
    });

    // Nút đặt: chuyển từ "process" -> "pending"
    document.getElementById('confirm-btn').addEventListener('click', () => {
        socket.emit('book-seat', { showtimeId });
    });

    // Nút huỷ tất cả ghế đang giữ
    document.getElementById('proceeded-btn').addEventListener('click', () => {
        socket.emit('release-booking-seats', { showtimeId });
    });

</script>

</body>
</html>
